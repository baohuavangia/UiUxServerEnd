@page "/forgot-password"

@using MenShopBlazor.DTOs.Account
@using MenShopBlazor.Services.Account
@inject IForgotPasswordService ForgotService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-6 mx-auto my-6" MaxWidth="400px">
    <MudText Typo="Typo.h6">QUÊN MẬT KHẨU</MudText>

    <MudForm @ref="_form" Model="model">
        @if (step == 1)
        {
            <MudTextField Label="Email" For="@(() => model.Email)" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2" OnClick="SendOtp">Gửi OTP</MudButton>
        }
        else if (step == 2)
        {
            <MudTextField Label="Nhập OTP" For="@(() => model.Otp)" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="VerifyOtp">Xác minh OTP</MudButton>
        }
        else if (step == 3)
        {
            <MudTextField Label="Mật khẩu mới"
                          For="@(() => model.NewPassword)"
                          InputType="InputType.Password" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ResetPassword">Đặt lại mật khẩu</MudButton>
        }
    </MudForm>
</MudPaper>

@code {
    private MudForm _form;
    private int step = 1;
    private ForgotPasswordStep model = new();

    private async Task SendOtp()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        var res = await ForgotService.SendOtpAsync(model.Email);
        if (res?.IsSuccess == true)
        {
            model.SessionId = res.Data.SessionId;
            step = 2;
            Snackbar.Add("Đã gửi OTP về email!", Severity.Success);
        }
        else
        {
            Snackbar.Add(res?.Message ?? "Lỗi không xác định", Severity.Error);
        }
    }

    private async Task VerifyOtp()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        var res = await ForgotService.VerifyOtpAsync(model.SessionId, model.Otp);
        if (res?.IsSuccess == true)
        {
            step = 3;
            Snackbar.Add("OTP hợp lệ, hãy nhập mật khẩu mới!", Severity.Success);
        }
        else
        {
            Snackbar.Add(res?.Message ?? "OTP không hợp lệ", Severity.Error);
        }
    }

    private async Task ResetPassword()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        var res = await ForgotService.ResetPasswordAsync(model.SessionId, model.NewPassword);
        if (res.IsSuccess)
        {
            Snackbar.Add("Đổi mật khẩu thành công! Hãy đăng nhập lại.", Severity.Success);
            model = new();
            step = 1;
            await Task.Delay(1500);
            Navigation.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add(res.Message, Severity.Error);
        }
    }
}

